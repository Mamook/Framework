(function(a){function g(c,b){this.$original=a(c);this.ignoreOriginalChangeEvent=this.ieClick=this.buildingSelect=!1;this.options=b;this.buildDom()}g.prototype={generateUid:function(a){return this.uid=this.options.containerClass+a},buildDom:function(){var c=this,b=this.options;"original"===b.addItemTarget&&a("option",this.$original).each(function(c,b){void 0===a(b).data("bsm-order")&&a(b).data("bsm-order",c)});for(var d=0;a("#"+this.generateUid(d)).size();d++);this.$select=a("<select>",{"class":b.selectClass, name:b.selectClass+this.uid,id:b.selectClass+this.uid,change:a.proxy(this.selectChangeEvent,this),click:a.proxy(this.selectClickEvent,this)});this.$list=a.isFunction(b.listType)?b.listType(this.$original):a("<"+b.listType+">",{id:b.listClass+this.uid});this.$list.addClass(b.listClass);this.$container=a("<div>",{"class":b.containerClass,id:this.uid});this.buildSelect();this.$original.change(a.proxy(this.originalChangeEvent,this)).wrap(this.$container).before(this.$select);this.$list.parent().length||this.$original.before(this.$list);this.$original.attr("id")&&a("label[for='"+this.$original.attr("id")+"']").attr("for",this.$select.attr("id"));this.$list.delegate("."+b.removeClass,"click",function(){c.dropListItem(a(this).closest("li"));return!1});a.each(b.plugins,function(){this.init(c)})},selectChangeEvent:function(){if(!a.browser||!a.browser.msie||!(7>a.browser.version)||this.ieClick){var c=a("option:selected:eq(0)",this.$select);c.data("orig-option")&&!1==this.triggerOriginalChange(c.data("orig-option"),"add")&&this.addListItem(c);this.ieClick=!1}},selectClickEvent:function(){this.ieClick=!0},originalChangeEvent:function(){this.ignoreOriginalChangeEvent?this.ignoreOriginalChangeEvent=!1:(this.buildSelect(),a.browser&&a.browser.opera&&this.$list.hide().show())},buildSelect:function(){var c=this;this.buildingSelect=!0;this.$select.empty().prepend(a('<option value=""></option>').text(this.$original.attr("title")||this.options.title));this.$list.empty();this.$original.children().each(function(){a(this).is("option")?c.addSelectOption(c.$select,a(this)):a(this).is("optgroup")&&c.addSelectOptionGroup(c.$select,a(this))});this.options.debugMode||this.$original.hide();this.selectFirstItem();this.buildingSelect=!1},addSelectOption:function(c,b){var d=a("<option>",{text:b.text(),val:b.val()}).appendTo(c).data("orig-option",b),e=b.is(":selected"),f=b.is(":disabled");b.data("bsm-option",d);e&&!f?(this.addListItem(d),this.disableSelectOption(d)):!e&&f&&this.disableSelectOption(d)},addSelectOptionGroup:function(c,b){var d=this,e=a("<optgroup>",{label:b.attr("label")}).appendTo(c);b.is(":disabled")&&e.attr("disabled","disabled");a("option",b).each(function(){d.addSelectOption(e,a(this))})},selectFirstItem:function(){a("option:eq(0)",this.$select).attr("selected","selected")},disableSelectOption:function(c){c.addClass(this.options.optionDisabledClass).removeAttr("selected").attr("disabled","disabled").toggle(!this.options.hideWhenAdded);a.browser&&(a.browser.msie&&8>a.browser.version)&&this.$select.hide().show()},enableSelectOption:function(c){c.removeClass(this.options.optionDisabledClass).removeAttr("disabled").toggle(!this.options.hideWhenAdded);a.browser&&(a.browser.msie&&8>a.browser.version)&&this.$select.hide().show()},addListItem:function(c){var b,d=c.data("orig-option"),e=this.options;if(d){if(!this.buildingSelect){if(d.is(":selected"))return;d.attr("selected","selected")}b=a("<li>",{"class":e.listItemClass}).append(a("<span>",{"class":e.listItemLabelClass,html:e.extractLabel(c,e)})).append(a("<a>",{href:"#","class":e.removeClass,html:e.removeLabel})).data("bsm-option",c);this.disableSelectOption(c.data("item",b));switch(e.addItemTarget){case "bottom":this.$list.append(b.hide());break;case "original":var f=d.data("bsm-order"),g=!1;this.$list.children().each(function(){if(f<a(this).data("bsm-option").data("orig-option").data("bsm-order"))return b.hide().insertBefore(this),g=!0,!1});g||this.$list.append(b.hide());break;default:this.$list.prepend(b.hide())}this.buildingSelect?a.bsmSelect.effects.show(b):(e.showEffect(b),e.highlightEffect(this.$select,b,e.highlightAddedLabel,this.options),this.selectFirstItem())}},dropListItem:function(c){var b=c.data("bsm-option"),d=this.options;!1==this.triggerOriginalChange(b.data("orig-option"),"drop")&&(b.removeData("item").data("orig-option").removeAttr("selected"),(this.buildingSelect?a.bsmSelect.effects.remove:d.hideEffect)(c),this.enableSelectOption(b),d.highlightEffect(this.$select,c,d.highlightRemovedLabel,d))},triggerOriginalChange:function(c,b){var d=a.Event("change");this.ignoreOriginalChangeEvent=!0;this.$original.trigger(d,[{option:c,value:c.val(),item:c.data("bsm-option").data("item"),type:b}]);return d.isDefaultPrevented()}};a.fn.bsmSelect=function(c){var b=a.extend({},a.bsmSelect.conf,c);return this.each(function(){var c=a(this).data("bsmSelect");c||(c=new g(a(this),b),a(this).data("bsmSelect",c))})};a.bsmSelect={};a.extend(a.bsmSelect,{effects:{show:function(a){a.show()},remove:function(a){a.remove()},highlight:function(c,b,d,e){var f=c.attr("id")+e.highlightClass;a("#"+f).remove();b=a("<span>",{"class":e.highlightClass,id:f,html:d+b.children("."+e.listItemLabelClass).first().text()}).hide();c.after(b.fadeIn("fast").delay(50).fadeOut("slow",function(){a(this).remove()}))},verticalListAdd:function(c){c.animate({opacity:"show",height:"show"},100,function(){a(this).animate({height:"+=2px"},100,function(){a(this).animate({height:"-=2px"},100)})})},verticalListRemove:function(c){c.animate({opacity:"hide",height:"hide"},100,function(){a(this).prev("li").animate({height:"-=2px"},100,function(){a(this).animate({height:"+=2px"},100)});a(this).remove()})}},plugins:{}});a.bsmSelect.conf={listType:"ol",showEffect:a.bsmSelect.effects.show,hideEffect:a.bsmSelect.effects.remove,highlightEffect:a.noop,addItemTarget:"bottom",hideWhenAdded:!1,debugMode:!1,title:"Select...",removeLabel:"remove",highlightAddedLabel:"Added: ",highlightRemovedLabel:"Removed: ",extractLabel:function(a){return a.html()},plugins:[],containerClass:"bsmContainer",selectClass:"bsmSelect",optionDisabledClass:"bsmOptionDisabled",listClass:"bsmList",listItemClass:"bsmListItem",listItemLabelClass:"bsmListItemLabel",removeClass:"bsmListItemRemove",highlightClass:"bsmHighlight"}})(jQuery);